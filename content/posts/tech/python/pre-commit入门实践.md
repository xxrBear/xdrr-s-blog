---
title: "pre-commit å…¥é—¨å®è·µ"
date: 2025-02-14T08:30:59+08:00
lastmod: 2025-02-14T08:30:59+08:00
author: ["ç†Šå¤§å¦‚å¦‚"]
tags: # æ ‡ç­¾
  - "python"
description: ""
weight:
slug: ""
summary: "pythoné¡¹ç›® pre-commit å®è·µ"
draft: false # æ˜¯å¦ä¸ºè‰ç¨¿
mermaid: true #æ˜¯å¦å¼€å¯mermaid
showToc: true # æ˜¾ç¤ºç›®å½•
TocOpen: true # è‡ªåŠ¨å±•å¼€ç›®å½•
hidemeta: false # æ˜¯å¦éšè—æ–‡ç« çš„å…ƒä¿¡æ¯ï¼Œå¦‚å‘å¸ƒæ—¥æœŸã€ä½œè€…ç­‰
disableShare: true # åº•éƒ¨ä¸æ˜¾ç¤ºåˆ†äº«æ 
showbreadcrumbs: true #é¡¶éƒ¨æ˜¾ç¤ºè·¯å¾„
cover:
  image: "https://cdn.jsdelivr.net/gh/xxrBear/image/icons8-python-500.png"
---

## ç®€ä»‹

`pre-commit` é¢„æäº¤æ˜¯ `git` çš„ä¸€ä¸ªé’©å­è„šæœ¬ï¼Œå®ƒå¯ä»¥åœ¨æˆ‘ä»¬ `git commit` æ—¶è¯†åˆ«ç®€å•é—®é¢˜ã€‚å½“æˆ‘ä»¬æ¯æ¬¡æäº¤æ—¶ä¼šè‡ªåŠ¨è¿è¡Œé’©å­è„šæœ¬ï¼Œä»¥è‡ªåŠ¨æŒ‡å‡ºä»£ç ä¸­çš„é—®é¢˜ï¼Œå¦‚ç¼©è¿›å¼‚å¸¸ã€ç¼ºå°‘åˆ†å·ã€å°¾éšç©ºæ ¼å’Œè°ƒè¯•è¯­å¥ã€‚åœ¨ä»£ç å®¡æŸ¥å‰æŒ‡å‡ºè¿™äº›é—®é¢˜ï¼Œè¿™å…è®¸ä»£ç å®¡æŸ¥è€…ä¸“æ³¨äºæäº¤çš„ä»£ç æœ¬èº«ï¼Œè€Œä¸ä¼šæµªè´¹æ—¶é—´åœ¨çç¢çš„æŸ¥çœ‹ä»£ç é£æ ¼æ˜¯å¦è§„èŒƒä¸Šã€‚

`git` è‡ªå¸¦äº†ä¸€ä¸ª `pre-commit` é’©å­è„šæœ¬ï¼Œä½†æ˜¯æœ¬æ–‡è®¨è®ºçš„ `pre-commit` æ˜¯ python å¼€å‘çš„ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œæ˜¯ä¸€ä¸ªç”¨äºç®¡ç†ä»£ç æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ï¼ˆGit Hookï¼‰çš„å·¥å…·æ¡†æ¶ï¼Œä¸“ä¸ºå¼€å‘è€…è®¾è®¡ï¼Œæ—¨åœ¨é€šè¿‡è‡ªåŠ¨åŒ–æ£€æŸ¥ç¡®ä¿ä»£ç è´¨é‡ã€ç»Ÿä¸€å›¢é˜Ÿè§„èŒƒã€‚

`pre-commit` ä¼šåœ¨ä½ æäº¤ä»£ç ä¹‹å‰è¿è¡Œä½ æŒ‡å®šçš„æ£€æŸ¥ã€‚å¦‚æœæ£€æŸ¥å‘ç°ä»»ä½•é”™è¯¯ï¼Œå®ƒä¼šé˜»æ­¢ä½ æäº¤ä»£ç ã€‚ä½ éœ€è¦ä¿®å¤é”™è¯¯åæ‰èƒ½æäº¤ä»£ç ã€‚

## å®‰è£…ä¸ä½¿ç”¨

### ä¸‹è½½ `pre-commit`

```python
pip install pre-commit
```

### å®‰è£… git é’©å­

- å®ƒä¼šåœ¨ä½ çš„ Git ä»“åº“ä¸­è‡ªåŠ¨åˆ›å»ºæˆ–æ›´æ–° `.git/hooks/pre-commit` æ–‡ä»¶

```shell
pre-commit install
```

### æ·»åŠ  `.pre-commit-config.yaml`æ–‡ä»¶

```shell
repos:
  - repo: https://github.com/PyCQA/flake8
    rev: 6.1.0
    hooks:
      - id: flake8
  - repo: https://github.com/PyCQA/isort
    rev: 5.12.0
    hooks:
      - id: isort
  - repo: https://github.com/psf/black
    rev: 23.3.0
    hooks:
      - id: black
```

- repo: è¿™æ˜¯è¦ä½¿ç”¨çš„ Git ä»“åº“ URLã€‚`pre-commit` ä¼šä»è¿™äº›ä»“åº“ä¸­ä¸‹è½½ç›¸åº”çš„å·¥å…·æˆ–è„šæœ¬
- rev: è¿™é‡ŒæŒ‡å®šäº†ä½ è¦ä½¿ç”¨çš„å·¥å…·çš„ç‰ˆæœ¬ï¼Œå³ Git æ ‡ç­¾
- hooks: åœ¨æ¯ä¸ªä»“åº“é…ç½®ä¸‹ï¼Œä½ å¯ä»¥å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªé’©å­ï¼ˆhooksï¼‰ã€‚è¿™äº›é’©å­ä¼šæ‰§è¡Œç›¸åº”çš„å·¥å…·
- id: æ¯ä¸ªé’©å­çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚è¿™é‡Œçš„é’©å­ `id` åˆ†åˆ«æ˜¯ `flake8`ã€`isort` å’Œ `black`ï¼Œè¿™è¡¨ç¤ºæ¯æ¬¡æäº¤æ—¶ï¼Œ`pre-commit` ä¼šè¿è¡Œç›¸åº”çš„å·¥å…·
- flake8: æ£€æŸ¥ python ä»£ç çš„é£æ ¼ã€æ½œåœ¨é”™è¯¯ç­‰
- isort: ä¼šæ•´ç† python ä»£ç ä¸­çš„å¯¼å…¥é¡ºåº
- black: ä¼šé‡æ–°æ ¼å¼åŒ–ä½ çš„ä»£ç ï¼Œä½¿å…¶ç¬¦åˆæ ‡å‡†æ ¼å¼

### <font style="color:rgb(64, 64, 64);">é¦–æ¬¡å…¨é‡æ£€æŸ¥</font>

```shell
pre-commit run --all-files
```

- è¿™å°†å¯¹é¡¹ç›®ä»£ç è¿è¡Œä¸Šè¿°è„šæœ¬

## å®è·µ

### åˆ›å»ºä¸€ä¸ª python æ¨¡å—

```shell
mkdir learn-pre-commit

vim main.py
```

### å¤åˆ¶ main.py å†…å®¹

```shell
def helloWorld():
  print("Hello World!")


if __name__ == "__main__":
    helloWorld()
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª py æ–‡ä»¶çš„ä»£ç æ˜¯ä¸ç¬¦åˆ Python PEP8 è§„èŒƒçš„

- ç¼©è¿›é”™è¯¯ï¼Œåªæœ‰ä¸¤ä¸ªç©ºæ ¼
- å‡½æ•°å‘½ä»¤é£æ ¼é”™è¯¯

### æå‰æ£€æŸ¥

```shell
pre-commit run --all-files
```

### ç»“æœ

```shell
(.venv) @bear âœ learn-pre-commit git(master) pre-commit run --all-files
flake8...................................................................Failed
- hook id: flake8
- exit code: 1

main.py:2:3: E111 indentation is not a multiple of 4

isort....................................................................Passed
black....................................................................Failed
- hook id: black
- files were modified by this hook

reformatted main.py

All done! \u2728 \U0001f370 \u2728
1 file reformatted.
```

æç¤ºï¼šflake8 å¤±è´¥ï¼Œblack å¤±è´¥

### æŸ¥çœ‹ main.py æ–‡ä»¶

```shell
def helloWorld():
    print("Hello World!")


if __name__ == "__main__":
    helloWorld()
```

æˆ‘ä»¬çœ‹åˆ°ç¼©è¿›å·²ç»æ­£å¸¸äº†ï¼Œè¿™æ˜¯ `black`çš„åŠŸåŠ³ï¼Œä½†æ˜¯å‡½æ•°é£æ ¼ä¾æ—§æ²¡æœ‰å˜ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ä¿®æ”¹å¦‚ä¸‹

```shell
def hello_world():
    print("Hello World!")


if __name__ == "__main__":
    hello_world()
```

### å†æ¬¡ä½¿ç”¨ pre-commit

ä¸Šé¢æˆ‘ä»¬ç›´æ¥è¿è¡Œäº†é’©å­è„šæœ¬ï¼Œå…¶å®åœ¨æˆ‘ä»¬ `commit`çš„æ˜¯å¦ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨è¿è¡Œï¼Œç°åœ¨è®©æˆ‘ä»¬ä½¿ç”¨è¿™ç§æ–¹å¼

```shell
git add .

git commit -m 'ä¿®æ”¹ main.py æ–‡ä»¶'
```

### å†æ¬¡æŸ¥çœ‹ç»“æœ

```shell
(.venv) @bear âœ learn-pre-commit git(master) git add .
(.venv) @bear âœ learn-pre-commit git(master) git ci -m "ä¿®æ”¹ main.py æ–‡ä»¶"
flake8...................................................................Passed
isort....................................................................Passed
black....................................................................Passed
[master 3afec46] ä¿®æ”¹ main.py æ–‡ä»¶
 1 file changed, 2 insertions(+), 2 deletions(-)
```

ä½ ä¼šçœ‹åˆ°ï¼Œå·²ç¬¦åˆ PEP8 é£æ ¼ï¼Œ`pre-commit`è„šæœ¬å…¨éƒ¨é€šè¿‡

## æ€»ç»“

`pre-commit` æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œå¯ä»¥å¸®åŠ©ä½ çš„é¡¹ç›®æ›´åŠ è‡ªåŠ¨åŒ–å’Œè§„èŒƒåŒ–ï¼Œä¹Ÿçœå»äº†å› ä¸ºä»£ç é£æ ¼ä¸åŒçš„æ‰¯çš® ğŸ˜…

æ€è€ƒä¸€ä¸‹ï¼Œå¦‚ä½•è®©å¼€å‘ç»„çš„å…¶ä»–åŒäº‹ä¸€èµ·ç”¨ `pre-commit`å‘¢ï¼Ÿ

è¿™å°±æ˜¯æœ¬æœŸåˆ†äº«ï¼Œå¦‚æœ‰ä¸è¶³ï¼Œè¯·æŒ‡æ­£~
