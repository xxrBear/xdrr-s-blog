---
title: "ä¸€æ–‡ç²—é€š Python asyncio å¹¶å‘ç¼–ç¨‹"
date: 2025-02-26T13:43:17+08:00
lastmod: 2025-02-26T13:43:17+08:00
author: ["ç†Šå¤§å¦‚å¦‚"]
keywords:
  -
categories: # åˆ†ç±»
  -  # åœ¨è¿™å„¿å†™åˆ†ç±»
tags: # æ ‡ç­¾
  - "python"
description: ""
weight:
slug: ""
summary: ""
draft: false # æ˜¯å¦ä¸ºè‰ç¨¿
mermaid: true #æ˜¯å¦å¼€å¯mermaid
showToc: true # æ˜¾ç¤ºç›®å½•
TocOpen: true # è‡ªåŠ¨å±•å¼€ç›®å½•
hidemeta: false # æ˜¯å¦éšè—æ–‡ç« çš„å…ƒä¿¡æ¯ï¼Œå¦‚å‘å¸ƒæ—¥æœŸã€ä½œè€…ç­‰
disableShare: true # åº•éƒ¨ä¸æ˜¾ç¤ºåˆ†äº«æ 
showbreadcrumbs: true #é¡¶éƒ¨æ˜¾ç¤ºè·¯å¾„
cover:
  image: "" # æ–‡ç« çš„å›¾ç‰‡
---

## ç®€ä»‹

æœ€è¿‘åœ¨å­¦ä¹  `Python asyncio` å¼‚æ­¥ç¼–ç¨‹ï¼Œä½†æ˜¯å‘ç°å…¶ä¸­éœ€è¦çš„å‰ç½®å†…å®¹å’ŒåŸºæœ¬æ¦‚å¿µéå¸¸å¤šï¼Œæ¯”å¦‚ `I/O` ä¸ `CPU` ä»»åŠ¡çš„åŒºåˆ«ã€å¹¶å‘ä¸å¹¶è¡Œçš„æ¦‚å¿µã€è¿›ç¨‹å’Œçº¿ç¨‹ã€å¤šä»»åŠ¡å¤„ç†ã€å…¨å±€è§£é‡Šå™¨é”ï¼ˆGILï¼‰ã€`asyncio`åº“çš„ä½¿ç”¨ç­‰ç­‰ã€‚ç‰¹æ­¤è®°å½•ä¸‹è‡ªå·±çš„å­¦ä¹ è¿‡ç¨‹ï¼Œå¸®åŠ©è‡ªå·±ç†è§£å’Œè®°å¿†ï¼Œä¹Ÿå¸Œæœ›å¯¹æƒ³å­¦ä¹ è¿™æ–¹é¢çŸ¥è¯†çš„åŒå­¦æœ‰ç‚¹å¸®åŠ©ã€‚

å¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿å¤§å®¶æŒ‡æ­£~

## ä¸€ã€I/O ä¸ CPU **å¯†é›†å‹**ä»»åŠ¡

### 1.1 I/O å¯†é›†å‹

`I/O`å¯†é›†å‹ä»»åŠ¡ æŒ‡çš„æ˜¯ ç¨‹åºçš„å¤§éƒ¨åˆ†æ—¶é—´èŠ±åœ¨ç­‰å¾…å¤–éƒ¨èµ„æºï¼ˆå¦‚ç£ç›˜ã€ç½‘ç»œã€æ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿç­‰ï¼‰çš„`I/O`æ“ä½œ ä¸Šï¼Œè€Œä¸æ˜¯æ‰§è¡Œ`CPU`è®¡ç®—ã€‚

ğŸ“Œ ä¾‹å­

ç½‘ç»œè¯·æ±‚ï¼ˆå¦‚ HTTP API è°ƒç”¨ã€çˆ¬è™«ï¼‰ã€ç½‘ç»œè¯·æ±‚ï¼ˆå¦‚ HTTP API è°ƒç”¨ã€çˆ¬è™«ï¼‰ã€æ•°æ®åº“æŸ¥è¯¢ï¼ˆå¦‚ MySQLã€PostgreSQL æŸ¥è¯¢ï¼‰ã€æ–‡ä»¶è¯»å†™ï¼ˆå¦‚è¯»å–å¤§æ–‡ä»¶ã€æ—¥å¿—å¤„ç†ï¼‰ã€ç£ç›˜`I/O`æ“ä½œï¼ˆå¦‚å­˜å‚¨å›¾ç‰‡ã€è§†é¢‘æµå¤„ç†ï¼‰ç­‰ç­‰ã€‚

### 1.2 **CPU å¯†é›†å‹ä»»åŠ¡**

`CPU` å¯†é›†å‹ä»»åŠ¡ æŒ‡çš„æ˜¯ç¨‹åºçš„å¤§éƒ¨åˆ†æ—¶é—´ç”¨äºæ‰§è¡Œå¤æ‚çš„è®¡ç®—ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ç­‰å¾… `I/O`æ“ä½œã€‚

ğŸ“Œ ä¾‹å­

æ•°å­¦è®¡ç®—ï¼ˆå¦‚çŸ©é˜µè¿ç®—ã€å‚…é‡Œå¶å˜æ¢ï¼‰ã€å›¾ç‰‡å¤„ç†ï¼ˆå¦‚ OpenCV å›¾åƒæ»¤æ³¢ï¼‰ã€å›¾ç‰‡å¤„ç†ï¼ˆå¦‚ OpenCV å›¾åƒæ»¤æ³¢ï¼‰ã€å¯†ç å“ˆå¸Œè®¡ç®—ï¼ˆå¦‚åŠ å¯†/è§£å¯†ï¼‰ç­‰ç­‰

## äºŒã€å¹¶å‘ä¸å¹¶è¡Œ

### 2.1 å¹¶å‘

å½“æˆ‘ä»¬è¯´ä¸¤ä¸ªä»»åŠ¡å¹¶å‘æ—¶ï¼Œæ˜¯æŒ‡è¿™ä¸ªä»»åŠ¡åŒæ—¶å‘ç”Ÿã€‚ä¾‹å¦‚ï¼Œå½“å¨å¸ˆåšèœçš„æ—¶å€™ï¼Œå…ˆç…®é¥­ï¼Œç„¶åç…®é¥­çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ¥ç€ç‚’èœã€‚

### 2.2 å¹¶è¡Œ

è™½ç„¶æˆ‘ä»¬å‰é¢è¯´å¹¶å‘æ„å‘³ç€å¤šä¸ªä»»åŠ¡åŒæ—¶è¿›è¡Œï¼Œä½†å¹¶ä¸æ„ä¸ºç€å®ƒä»¬å¹¶è¡Œè¿è¡Œï¼Œè®©æˆ‘ä»¬å›åˆ°åšèœçš„ä¾‹å­ï¼Œç‚’èœçš„æ—¶å€™ï¼Œæˆ‘ä»¬å†åŠ ä¸€ä¸ªå¨å­ï¼Œä¸€ä¸ªç‚’é¸¡è›‹ä¸€ä¸ªç‚’é’èœï¼Œä¸¤ä¸ªåŒæ—¶å‘ç”Ÿï¼Œä¸”åŒæ—¶è¿›è¡Œã€‚

### 2.3 æ€»ç»“

åœ¨å•æ ¸`CPU`ä¸­ï¼Œå¹¶å‘æ„å‘³ç€ä»»åŠ¡åˆ‡æ¢ï¼Œè®©ä¸€ä¸ªä»»åŠ¡è¿è¡Œä¸€ä¼šå„¿ï¼Œå†è®©å¦ä¸€ä¸ªä»»åŠ¡è¿è¡Œä¸€ä¼šå„¿ã€‚å•æ ¸`CPU`çš„æœºå™¨ä¸­ï¼Œå¹¶è¡Œå¹¶ä¸å­˜åœ¨ã€‚

è€Œåœ¨å¤šæ ¸`CPU`çš„æœºå™¨ä¸­ï¼Œå¹¶è¡Œæ„ä¸ºç€ä¸¤ä¸ªä»»åŠ¡éƒ½æ˜¯è¿è¡Œï¼Œä¸€ä¸ªä»»åŠ¡åœ¨è¿è¡Œï¼Œå¦ä¸€ä¸ªä¹Ÿåœ¨è¿è¡Œï¼Œä¸ç”¨åˆ‡æ¢ã€‚

å³å¹¶è¡Œä¸€å®šæ˜¯å¹¶å‘ï¼Œä½†å¹¶å‘ä¸ä¸€å®šæ˜¯å¹¶è¡Œã€‚

## ä¸‰ã€è¿›ç¨‹å’Œçº¿ç¨‹

### 3.1. **è¿›ç¨‹**

**æ¦‚å¿µ**ï¼šè¿›ç¨‹æ˜¯ç¨‹åºåœ¨æ“ä½œç³»ç»Ÿä¸­è¿è¡Œçš„ä¸€ä¸ªç¨‹åºã€‚æ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ã€èµ„æºï¼ˆå¦‚æ–‡ä»¶å¥æŸ„ã€è®¾å¤‡ç­‰ï¼‰å’Œæ‰§è¡Œç¯å¢ƒã€‚

**ç‰¹ç‚¹**ï¼š

- æ¯ä¸ªè¿›ç¨‹æ˜¯ç‹¬ç«‹çš„ï¼Œæ‹¥æœ‰è‡ªå·±çš„å†…å­˜ç©ºé—´å’Œèµ„æºã€‚
- è¿›ç¨‹ä¹‹é—´ä¸å…±äº«æ•°æ®ï¼Œé€šä¿¡éœ€è¦ä½¿ç”¨è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰ï¼Œå¦‚ç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ã€‚
- å¯åŠ¨å’Œé”€æ¯è¿›ç¨‹çš„å¼€é”€è¾ƒå¤§ã€‚

### 3.2. **çº¿ç¨‹**

**æ¦‚å¿µ**ï¼šçº¿ç¨‹æ˜¯è¿›ç¨‹å†…éƒ¨çš„æ‰§è¡Œå•ä½ã€‚æ¯ä¸ªè¿›ç¨‹è‡³å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰ã€‚å¤šä¸ªçº¿ç¨‹å¯ä»¥å…±äº«åŒä¸€è¿›ç¨‹çš„å†…å­˜å’Œèµ„æºã€‚

**ç‰¹ç‚¹**ï¼š

- çº¿ç¨‹åœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…å…±äº«å†…å­˜ç©ºé—´ï¼ˆä¾‹å¦‚ï¼Œå †å†…å­˜ï¼‰ã€‚
- çº¿ç¨‹ä¹‹é—´å¯ä»¥å…±äº«æ•°æ®ã€‚
- çº¿ç¨‹çš„åˆ›å»ºã€é”€æ¯å’Œåˆ‡æ¢å¼€é”€è¾ƒå°ã€‚

### 3.3. **è¿›ç¨‹ä¸çº¿ç¨‹çš„åŒºåˆ«**

| **ç‰¹æ€§**     | **è¿›ç¨‹ï¼ˆProcessï¼‰**                  | **çº¿ç¨‹ï¼ˆThreadï¼‰**                 |
| ------------ | ------------------------------------ | ---------------------------------- |
| **ç‹¬ç«‹æ€§**   | æ¯ä¸ªè¿›ç¨‹æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œäº’ä¸å¹²æ‰°ã€‚ | çº¿ç¨‹å…±äº«è¿›ç¨‹çš„å†…å­˜ç©ºé—´å’Œèµ„æºã€‚     |
| **èµ„æº**     | æ‹¥æœ‰ç‹¬ç«‹çš„èµ„æºï¼ˆå†…å­˜ã€æ–‡ä»¶ç­‰ï¼‰ã€‚     | å…±äº«è¿›ç¨‹çš„èµ„æºã€‚                   |
| **é€šä¿¡æ–¹å¼** | è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æ¯”è¾ƒå¤æ‚ä¸”å¼€é”€å¤§ã€‚  | çº¿ç¨‹é—´é€šä¿¡é«˜æ•ˆï¼Œé€šå¸¸é€šè¿‡å…±äº«å†…å­˜ã€‚ |
| **å´©æºƒå½±å“** | ä¸€ä¸ªè¿›ç¨‹å´©æºƒä¸ä¼šå½±å“å…¶ä»–è¿›ç¨‹ã€‚       | ä¸€ä¸ªçº¿ç¨‹å´©æºƒå¯èƒ½å¯¼è‡´æ•´ä¸ªè¿›ç¨‹å´©æºƒã€‚ |
| **å¼€é”€**     | è¿›ç¨‹çš„åˆ›å»ºå’Œåˆ‡æ¢å¼€é”€è¾ƒå¤§ã€‚           | çº¿ç¨‹çš„åˆ›å»ºå’Œåˆ‡æ¢å¼€é”€è¾ƒå°ã€‚         |

### 3.4. **æ€»ç»“**

- **è¿›ç¨‹**ï¼šé€‚åˆéœ€è¦éš”ç¦»å’Œç‹¬ç«‹æ‰§è¡Œçš„ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œè¿è¡Œä¸åŒçš„ç¨‹åºã€‚
- **çº¿ç¨‹**ï¼šé€‚åˆéœ€è¦å¹¶å‘æ‰§è¡Œçš„ä»»åŠ¡ã€‚ä¾‹å¦‚ï¼Œç¨‹åºå†…éƒ¨çš„å¤šä¸ªä»»åŠ¡åŒæ—¶è¿›è¡Œï¼ˆå¦‚ç½‘é¡µä¸‹è½½ã€æ–‡ä»¶è¯»å–ç­‰ï¼‰ã€‚

## å››ã€å¤šä»»åŠ¡å¤„ç†

### 4.1 æŠ¢å å¼å¤šä»»åŠ¡

åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œç”±æ“ä½œç³»ç»Ÿç¡®å®šå¤šä¸ªä»»åŠ¡çš„åˆ‡æ¢ï¼Œä¸»è¦é€šè¿‡ä½¿ç”¨å¤šä¸ªçº¿ç¨‹æˆ–å¤šä¸ªè¿›ç¨‹æ¥å®ç°ã€‚

### 4.2 ååŒå¤šä»»åŠ¡

åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œæ˜¯æ˜¾å¼çš„ç¼–å†™åº”ç”¨ç¨‹åºï¼Œè°ƒåº¦ä»»åŠ¡çš„è¿è¡Œã€‚

### 4.3 ååŒå¼å¤šä»»åŠ¡å¤„ç†çš„ä¼˜åŠ¿

`asyncio`ä½¿ç”¨ååŒå¤šä»»åŠ¡æ¥å®ç°å¹¶å‘æ€§ã€‚

å½“åº”ç”¨ç¨‹åºæ‰§è¡Œ`I/O`å¯†é›†å‹ä»»åŠ¡ç­‰å¾…çš„æ—¶å€™ï¼Œå¯ä»¥æ˜¾ç¤ºçš„åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ï¼Œè¿™æ˜¯ä¸€ç§å¹¶å‘æ¨¡å¼ï¼Œä¸æ˜¯å¹¶è¡Œæ¨¡å¼ã€‚

ååŒå¼å¤šä»»åŠ¡ä¸ä¼šåƒçº¿ç¨‹æˆ–è¿›ç¨‹é‚£æ ·éœ€è¦æ“ä½œç³»ç»Ÿçš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå› æ­¤ï¼š

- ä¸éœ€è¦`CPU`åˆ‡æ¢æˆæœ¬ï¼ˆè¿›ç¨‹/çº¿ç¨‹åˆ‡æ¢éœ€è¦ä¿å­˜/æ¢å¤å¯„å­˜å™¨ã€å †æ ˆç­‰ï¼‰ã€‚
- æ¶ˆè€—æ›´å°‘çš„å†…å­˜ï¼Œé€‚ç”¨äºé«˜å¹¶å‘ï¼ˆå¦‚çˆ¬è™«ã€å¼‚æ­¥ IO æœåŠ¡å™¨ï¼‰ã€‚
- é¿å…çº¿ç¨‹é”é—®é¢˜ï¼Œæ— éœ€æ‹…å¿ƒç«äº‰æ¡ä»¶ã€æ­»é”ç­‰é—®é¢˜ã€‚

## äº”ã€å…¨å±€è§£é‡Šå™¨é”

### 5.1 ç®€ä»‹

å…¨å±€è§£é‡Šå™¨é”æ˜¯ `Global Interpreter Lock`å³ `GIL`ã€‚

`GIL` ç»„ç»‡ä¸€ä¸ª`Python`è¿›ç¨‹åœ¨åŒä¸€æ—¶åˆ»æ‰§è¡Œå¤šä¸ª`Python`å­—èŠ‚ç æŒ‡ä»¤ã€‚è¿™æ„å‘³ç€ï¼Œå³ä½¿åœ¨å¤šæ ¸æœºå™¨ä¸Šæœ‰å¤šä¸ªçº¿ç¨‹ï¼Œ`Python`è¿›ç¨‹ä¸€æ¬¡ä¹Ÿåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¿è¡Œ`Python`ä»£ç ã€‚

> Python å¤šè¿›ç¨‹å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªå­—èŠ‚ç æŒ‡ä»¤ï¼Œæ¯ä¸ª Python è¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ GIL

`GIL`ä¸ºä»€ä¹ˆä¼šå­˜åœ¨ï¼Ÿä¸»è¦æ˜¯å› ä¸º`Cpython`ç®¡ç†å†…å­˜çš„æ–¹å¼ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œè°·æ­Œ ğŸ™‚

### 5.2 GIL çš„é‡Šæ”¾æ¡ä»¶

å½“ `I/O` æ“ä½œå‘ç”Ÿæ—¶ï¼Œ`GIL` ä¼šé‡Šæ”¾ã€‚ä½†`CPU`å¯†é›†å‹ä»»åŠ¡è¿è¡Œæ—¶ä¸ä¼šã€‚

è‡³äºä¸ºä»€ä¹ˆï¼Œæˆ‘ä»¬åé¢ä¼šè§£é‡Šã€‚

ğŸ“Œ ä¸¾ä¸ªä¾‹å­

```python
import time
import requests


def get_url():
    response = requests.get('https://www.example.com')
    print(response.status_code)


start_time = time.time()
get_url()
get_url()
end_time = time.time()

print(f'è¿è¡Œä¸¤ä¸ªä»»åŠ¡ç”¨æ—¶ {end_time - start_time} ç§’

# è¾“å‡º
# 200
# 200
# è¿è¡Œä¸¤ä¸ªä»»åŠ¡ç”¨æ—¶ 0.4522264003753662 ç§’
```

çœ‹ï¼Œè¿™æ˜¯åŒæ­¥æ‰§è¡ŒèŠ±è´¹çš„æ—¶é—´ï¼Œè®©æˆ‘ä»¬ç”¨å¤šçº¿ç¨‹ç¨‹åºå†å°è¯•ä¸€ä¸‹

```python
import time
import threading

import requests


def get_url():
    response = requests.get('https://www.example.com')
    print(response.status_code)


start_time = time.time()

t1 = threading.Thread(target=get_url)
t2 = threading.Thread(target=get_url)

t1.start()
t2.start()

t1.join()
t2.join()

end_time = time.time()


print(f'è¿è¡Œä¸¤ä¸ªä»»åŠ¡ç”¨æ—¶ {end_time - start_time} ç§’')


# 200
# 200
# è¿è¡Œä¸¤ä¸ªä»»åŠ¡ç”¨æ—¶ 0.23043560981750488 ç§’
```

è¿™æ¯”ä¸ä½¿ç”¨å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œå¤§æ¦‚å¿«äº†ä¸€å€ã€‚

é‚£ä¹ˆï¼Œå›åˆ°æˆ‘ä»¬å‰é¢çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆåœ¨è¿è¡Œ `I/O` ä»»åŠ¡çš„æ—¶å€™ï¼Œä¼šé‡Šæ”¾ `GIL` å‘¢ï¼Ÿ

è¿™ä¸»è¦æ˜¯å› ä¸ºï¼Œè¿è¡Œ `I/O` ä»»åŠ¡æ—¶ï¼Œ`CPU` ä¸ç›´æ¥ä¸ Python æ“ä½œå¯¹è±¡ï¼Œè¿™ç§æ—¶å€™ï¼Œ`GIL`åªæœ‰åœ¨æ¥æ”¶åˆ°çš„æ•°æ®å˜æˆ `Python` å¯¹è±¡çš„æ—¶å€™æ‰ä¼šé‡æ–°è·å–ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ `Python` ä¸­ï¼Œå› ä¸º `GIL` çš„å­˜åœ¨ï¼Œæˆ‘ä»¬æœ€å¤šå¹¶è¡ŒåŒ– `IO` æ“ä½œï¼Œä»è€Œæå‡è¿è¡Œæ•ˆç‡ï¼Œè€Œå¯¹äº `CPU` æ“ä½œï¼Œå› ä¸º `GIL` çš„å­˜åœ¨ `Python` æå‡ä¸äº†æ•ˆç‡ ğŸ™ƒğŸ™ƒ

### 5.3 asyncio ä¸ GIL

å› ä¸º`asyncio`æ˜¯å•çº¿ç¨‹å¹¶å‘æ¨¡å‹ï¼Œæ‰€ä»¥å®ƒæ˜¯åˆ©ç”¨é‡Šæ”¾`I/O`æä¾›å¹¶å‘æ€§ï¼Œæå‡æ€§èƒ½ã€‚

æ‰€ä»¥ï¼Œ`asyncio` ä¾ç„¶é™åˆ¶äº `GIL`ï¼Œå¯¹äº `CPU` å¯†é›†å‹ä»»åŠ¡ï¼Œå®ƒè¿˜æ˜¯æ— èƒ½ä¸ºåŠ›ï¼Œè¿˜æ˜¯éœ€è¦ä½¿ç”¨ `Python` å¤šè¿›ç¨‹æ¥å¤„ç†

### 5.4 å¼‚æ­¥å¤„ç† I/O é€Ÿåº¦å¿«é€Ÿçš„åŸå› 

å‰é¢è§£é‡Šè¿‡åŸå› äº†ã€‚ä¸€å›¾èƒœåƒè¨€ï¼š

![](https://cdn.jsdelivr.net/gh/xxrBear/image//Hugo/202502261241086.png)

ä»”ç»†çœ‹ï¼Œè“è‰²é‡å éƒ¨åˆ†å°±æ˜¯å¼‚æ­¥å¤„ç†èŠ‚çº¦çš„æ—¶é—´ã€‚

## å…­ã€Python asyncio å¼‚æ­¥ç¼–ç¨‹

### 6.1 asyncio æ˜¯ä»€ä¹ˆ

`asyncio`æ˜¯`Python`æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªå¼‚æ­¥`I/O`æ¡†æ¶ã€‚ä½†ä»`python3.4`å¼€å§‹å¼•å…¥ï¼Œåˆ° `python3.7` çš„æˆç†Ÿï¼Œ`asyncio` å…¶å®å·²ç»æ¨å‡ºè®¸å¤šå¹´äº†ã€‚å®ƒæ˜¯å•çº¿ç¨‹å¹¶å‘æ¨¡å‹ï¼Œä¸»è¦ç”¨äº`I/O`å¯†é›†å‹ä»»åŠ¡

### 6.2 ç®€å•çš„ä½¿ç”¨

```python
import asyncio

async def main():
    print('hello')
    await asyncio.sleep(1)
    print()

asyncio.run(main())
```

### 6.3 asyncio.run()åšäº†ä»€ä¹ˆï¼Ÿ

- åˆ›å»ºäº‹ä»¶å¾ªç¯
- è¿è¡Œä¼ å…¥çš„åç¨‹
- å…³é—­äº‹ä»¶å¾ªç¯

### 6.4 asyncio çš„ä¼˜ç‚¹

ä¹‹å‰æˆ‘ä»¬è¯´äº†ï¼Œ`asyncio`çš„å¹¶å‘æ¨¡å‹æ˜¯å•çº¿ç¨‹å¹¶å‘æ¨¡å‹ï¼Œé‚£ä½ çŸ¥é“è·Ÿå¤šçº¿ç¨‹ç›¸æ¯”ï¼Œ`asyncio`çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆå˜› ğŸ™ƒ

1. `asyncio` ä½¿ç”¨åç¨‹æ¥å®ç°å¹¶å‘ï¼Œåç¨‹æ˜¯è½»é‡çº§çš„ä»»åŠ¡å•å…ƒï¼Œå…±äº«åŒä¸€ä¸ªçº¿ç¨‹çš„æ ˆç©ºé—´ï¼Œåˆ›å»ºå’Œåˆ‡æ¢çš„å¼€é”€è¿œå°äºçº¿ç¨‹ã€‚è¿™ä½¿å¾— `asyncio` èƒ½å¤Ÿæ”¯æŒæ›´å¤šçš„å¹¶å‘ä»»åŠ¡ï¼Œç‰¹åˆ«é€‚åˆé«˜å¹¶å‘çš„åº”ç”¨åœºæ™¯ã€‚
2. `asyncio` æ˜¯å•çº¿ç¨‹çš„ï¼Œåç¨‹åœ¨äº‹ä»¶å¾ªç¯ä¸­æŒ‰é¡ºåºæ‰§è¡Œï¼Œé¿å…äº†å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­å¸¸è§çš„ç«æ€æ¡ä»¶é—®é¢˜ã€‚å› æ­¤ï¼Œå¼€å‘è€…æ— éœ€æ‹…å¿ƒçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä»£ç æ›´åŠ ç®€å•å’Œå®‰å…¨ã€‚
3. ç›¸æ¯”äºå¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œ`asyncio` æä¾›äº†æ›´ç®€å•çš„å¹¶å‘æ¨¡å‹ã€‚å¤šçº¿ç¨‹ç¼–ç¨‹éœ€è¦è€ƒè™‘çº¿ç¨‹çš„åˆ›å»ºã€åŒæ­¥å’Œé€šä¿¡ç­‰é—®é¢˜ï¼Œä»£ç å¤æ‚ä¸”éš¾ä»¥è°ƒè¯•ã€‚è€Œ `asyncio` ä½¿ç”¨ `async/await` è¯­æ³•ï¼Œä»£ç ç»“æ„æ¸…æ™°ï¼Œé€»è¾‘ç®€å•ï¼Œå¼€å‘è€…å¯ä»¥åƒå†™åŒæ­¥ä»£ç ä¸€æ ·å†™å¼‚æ­¥ä»£ç ï¼Œé™ä½äº†å¹¶å‘ç¼–ç¨‹çš„å¤æ‚æ€§ã€‚
4. `asyncio` å…·æœ‰æ›´å¥½çš„æ‰©å±•æ€§ã€‚ç”±äºçº¿ç¨‹çš„å¼€é”€è¾ƒå¤§ï¼Œç³»ç»Ÿèƒ½å¤Ÿæ”¯æŒçš„çº¿ç¨‹æ•°é‡æœ‰é™ï¼Œå¤šçº¿ç¨‹æ¨¡å‹åœ¨å¤„ç†å¤§é‡å¹¶å‘è¿æ¥æ—¶å¯èƒ½ä¼šé‡åˆ°ç“¶é¢ˆã€‚è€Œ `asyncio` å¯ä»¥è½»æ¾æ”¯æŒæˆåƒä¸Šä¸‡çš„å¹¶å‘åç¨‹ï¼Œéå¸¸é€‚åˆé«˜å¹¶å‘çš„åº”ç”¨åœºæ™¯ï¼Œå¦‚ Web æœåŠ¡å™¨ã€ç½‘ç»œçˆ¬è™«ç­‰ã€‚

## ä¸ƒã€å¦‚ä½•è¿è¡Œä¸€ä¸ªåç¨‹å‡½æ•°

æ³¨æ„ï¼šç®€å•åœ°è°ƒç”¨ä¸€ä¸ªåç¨‹å¹¶ä¸ä¼šä½¿å…¶è¢«è°ƒåº¦æ‰§è¡Œ

```python
>>> main()

<coroutine object main at 0x1053bb7c8>
```

### 7.1 asyncio.run

å‰é¢ä»‹ç»è¿‡äº†

### 7.2 <font style="color:rgb(0, 0, 0);">await</font>

`await`å…³é”®å­—åé¢è¿è¡Œåç¨‹å‡½æ•°ã€‚

æ³¨æ„ï¼š`await`å…³é”®å­—åªèƒ½åœ¨åç¨‹å‡½æ•°å†…éƒ¨ä½¿ç”¨ï¼Œå®ƒæ˜¯ä¸èƒ½åœ¨æ™®é€šå‡½æ•°å†…éƒ¨ä½¿ç”¨çš„ã€‚

```python
import asyncio
import time

async def say_after(delay, what):
    await asyncio.sleep(delay)
    print(what)

async def main():
    print(f"started at {time.strftime('%X')}")

    await say_after(1, 'hello')
    await say_after(2, 'world')

    print(f"finished at {time.strftime('%X')}")

asyncio.run(main())
```

å®é™…è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œä½ ä¼šå‘ç°æ€»å…±ç”¨æ—¶ 3 ç§’å·¦å³ï¼Œè€Œä¸æ˜¯ 2 ç§’ï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯æƒ³è®©ä¸Šè¿°ä»£ç å¹¶å‘çš„è¿è¡Œï¼Œæ€»ç”¨æ—¶åº”è¯¥åœ¨ 2 ç§’å·¦å³å¯¹å§ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¼šç”¨æ—¶ 3 ç§’å‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸º `await`å…³é”®å­—ï¼Œä¼šäº¤å‡ºå½“å‰åç¨‹å‡½æ•°çš„æ§åˆ¶æƒï¼Œæš‚åœå½“å‰åç¨‹ï¼Œä¹Ÿå°±æ˜¯è¯´ `main`å‡½æ•°è¢«é˜»å¡äº†ï¼Œå¾—ç­‰ç¬¬ä¸€ä¸ª `say_after`è¿è¡Œç»“æŸä¹‹åï¼Œæ‰èƒ½è¿è¡Œç¬¬äºŒä¸ª `say_after`å‡½æ•°ã€‚

æ¢å¥è¯è¯´ï¼Œ`await`å…³é”®å­—çš„ä½œç”¨ä¼šé˜»å¡å½“å‰åç¨‹ï¼Œå°†å¼‚æ­¥å˜åŒæ­¥ã€‚

é‚£æƒ³å¹¶å‘ç›´æ¥ä¸¤ä¸ªåç¨‹å‡½æ•°æ€ä¹ˆåŠå‘¢ï¼Ÿçœ‹ä¸‹é¢ã€‚

### 7.3 <font style="color:rgb(0, 0, 0);">asyncio.</font>**<font style="color:rgb(0, 0, 0);">create_task</font>**

```python
import asyncio
import time

async def say_after(delay, what):
    await asyncio.sleep(delay)
    print(what)

async def main():
    task1 = asyncio.create_task(
        say_after(1, 'hello'))

    task2 = asyncio.create_task(
        say_after(2, 'world'))

    print(f"started at {time.strftime('%X')}")

    # ç­‰å¾…ç›´åˆ°ä¸¤ä¸ªä»»åŠ¡éƒ½å®Œæˆ
    # ï¼ˆä¼šèŠ±è´¹çº¦ 2 ç§’é’Ÿã€‚ï¼‰
    await task1
    await task2

    print(f"finished at {time.strftime('%X')}")

asyncio.run(main())
```

è¿è¡Œè¿™æ®µä»£ç ï¼Œä½ ä¼šå‘ç°ç”¨æ—¶ 2 ç§’å·¦å³ã€‚

è¿™æ˜¯å› ä¸ºï¼Œä½¿ç”¨ `create_task`å‡½æ•°ï¼Œä¼šå°†å½“å‰åç¨‹å‡½æ•°åŒ…è£…åˆ° `Task`ç±»ä¸­ï¼Œç„¶åäº¤ç»™äº‹ä»¶å¾ªç¯ï¼Œäº‹ä»¶å¾ªç¯è¿è¡Œæ—¶ï¼Œä¼šå¹¶å‘è°ƒåº¦ä¸¤ä¸ªåç¨‹å‡½æ•°ï¼Œè¾¾åˆ°å‡å°‘èŠ±è´¹ç”¨æ—¶çš„ç›®çš„ã€‚

### 7.4 asyncio.TaskGroup

```python
async def main():
    async with asyncio.TaskGroup() as tg:
        task1 = tg.create_task(
            say_after(1, 'hello'))

        task2 = tg.create_task(
            say_after(2, 'world'))

        print(f"started at {time.strftime('%X')}")

    # å½“å­˜åœ¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ—¶ await æ˜¯éšå¼æ‰§è¡Œçš„ã€‚
    print(f"finished at {time.strftime('%X')}")
```

> Python3.11 æ–°å¢åŠŸèƒ½

## å…«ã€å¯ç­‰å¾…å¯¹è±¡

å¦‚æœä¸€ä¸ªå¯¹è±¡å¯ä»¥åœ¨`await`è¯­å¥ä¸­ä½¿ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ å¯ç­‰å¾…å¯¹è±¡ã€‚

å¯ç­‰å¾…å¯¹è±¡æœ‰ä¸‰ç§ä¸»è¦ç±»å‹: **åç¨‹å¯¹è±¡ï¼ŒTask å’Œ Future**

### 8.1 åç¨‹

Python åç¨‹å±äºå¯ç­‰å¾…å¯¹è±¡ï¼Œå› æ­¤å¯ä»¥åœ¨å…¶ä»–åç¨‹ä¸­è¢«ç­‰å¾…

```python
import asyncio

async def nested():
    return 42

async def main():
    # å¦‚æœæˆ‘ä»¬åªè°ƒç”¨ "nested()" åˆ™æ— äº‹å‘ç”Ÿã€‚
    # ä¸€ä¸ªåç¨‹å¯¹è±¡ä¼šè¢«åˆ›å»ºä½†æ˜¯ä¸ä¼šè¢«ç­‰å¾…ï¼Œ
    # å› æ­¤å®ƒ *æ ¹æœ¬ä¸ä¼šè¿è¡Œ*ã€‚
    nested()  # å°†å¼•å‘ "RuntimeWarning"ã€‚

    # ç°åœ¨è®©æˆ‘ä»¬æ”¹ä¸ºç­‰å¾…å®ƒï¼š
    print(await nested())  # å°†æ‰“å° "42"ã€‚

asyncio.run(main())
```

### 8.2 Task

Task è¢«ç”¨æ¥â€œå¹¶è¡Œçš„â€è°ƒåº¦åç¨‹

å½“ä¸€ä¸ªåç¨‹é€šè¿‡`asyncio.create_task`ç­‰å‡½æ•°è¢«å°è£…ä¸ºä¸€ä¸ª Taskï¼Œè¯¥åç¨‹ä¼šè¢«è‡ªåŠ¨è°ƒåº¦æ‰§è¡Œ:

```python
import asyncio

async def nested():
    return 42

async def main():
    # å°† nested() åŠ å…¥è®¡åˆ’ä»»åŠ¡
    # ç«‹å³ä¸ "main()" å¹¶å‘è¿è¡Œã€‚
    task = asyncio.create_task(nested())

    # ç°åœ¨å¯ä»¥ä½¿ç”¨ "task" æ¥å–æ¶ˆ "nested()" æˆ– ç®€å•åœ°ç­‰å¾…å®ƒç›´åˆ°å®ƒè¢«å®Œæˆï¼š
    await task

asyncio.run(main())
```

### 8.3 Future

`Future`æ˜¯ä¸€ç§ç‰¹æ®Šçš„**ä½å±‚çº§**å¯ç­‰å¾…å¯¹è±¡ï¼Œè¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„**æœ€ç»ˆç»“æœ**ã€‚

å½“ä¸€ä¸ª`Future`å¯¹è±¡è¢«ç­‰å¾…ï¼Œè¿™æ„å‘³ç€åç¨‹å°†ä¿æŒç­‰å¾…ç›´åˆ°è¯¥`Future`å¯¹è±¡åœ¨å…¶ä»–åœ°æ–¹æ“ä½œå®Œæ¯•ã€‚

åœ¨`asyncio` ä¸­éœ€è¦ `Future` å¯¹è±¡ä»¥ä¾¿å…è®¸é€šè¿‡ `async/await` ä½¿ç”¨åŸºäºå›è°ƒçš„ä»£ç ã€‚

`Future`å¯¹è±¡æœ‰æ—¶ä¼šç”¨æ¥åŒ…è£…æ™®é€šå‡½æ•°ï¼Œç”¨ä½œå¯ç­‰å¾…å¯¹è±¡ã€‚

é€šå¸¸æƒ…å†µä¸‹æ²¡æœ‰å¿…è¦ åœ¨åº”ç”¨å±‚çº§çš„ä»£ç ä¸­åˆ›å»º`Future`å¯¹è±¡ã€‚

- **ä¸€ä¸ª**`**Future**`**çš„ç¤ºä¾‹**

```python
async def main():
    # è·å–å½“å‰äº‹ä»¶å¾ªç¯
    loop = asyncio.get_running_loop()

    # # åˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼ˆFutureå¯¹è±¡ï¼‰ï¼Œè¿™ä¸ªä»»åŠ¡ä»€ä¹ˆéƒ½ä¸å¹²ã€‚
    fut = loop.create_future()

    # ç­‰å¾…ä»»åŠ¡æœ€ç»ˆç»“æœï¼ˆFutureå¯¹è±¡ï¼‰ï¼Œæ²¡æœ‰ç»“æœåˆ™ä¼šä¸€ç›´ç­‰ä¸‹å»ã€‚
    await fut

asyncio.run(main())
```

è¿è¡Œä¸Šé¢çš„ä»£ç ï¼Œä½ ä¼šå‘ç°ç¨‹åºå¡æ­»äº†ï¼Œä¸Šé¢è¯´äº†ï¼Œ`Future`å¯¹è±¡ä¸€å®šè¦è¢«è®¾ç½®ä¸€ä¸ªå€¼ï¼Œå¦åˆ™ä¼šä¸€ç›´ç­‰å¾…ï¼Œç°åœ¨ï¼Œè®©æˆ‘ä»¬æ”¹å†™ä¸€ä¸‹

```python
import asyncio


async def set_after(fut):
    await asyncio.sleep(2)
    fut.set_result("666")


async def main():
    # è·å–å½“å‰äº‹ä»¶å¾ªç¯
    loop = asyncio.get_running_loop()

    # åˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼ˆFutureå¯¹è±¡ï¼‰ï¼Œæ²¡ç»‘å®šä»»ä½•è¡Œä¸ºï¼Œåˆ™è¿™ä¸ªä»»åŠ¡æ°¸è¿œä¸çŸ¥é“ä»€ä¹ˆæ—¶å€™ç»“æŸã€‚
    fut = loop.create_future()

    # åˆ›å»ºä¸€ä¸ªä»»åŠ¡ï¼ˆTaskå¯¹è±¡ï¼‰ï¼Œç»‘å®šäº†set_afterå‡½æ•°ï¼Œå‡½æ•°å†…éƒ¨åœ¨2sä¹‹åï¼Œä¼šç»™futèµ‹å€¼ã€‚
    # å³æ‰‹åŠ¨è®¾ç½®futureä»»åŠ¡çš„æœ€ç»ˆç»“æœï¼Œé‚£ä¹ˆfutå°±å¯ä»¥ç»“æŸäº†ã€‚
    await loop.create_task(set_after(fut))

    # ç­‰å¾… Futureå¯¹è±¡è·å– æœ€ç»ˆç»“æœï¼Œå¦åˆ™ä¸€ç›´ç­‰ä¸‹å»
    data = await fut
    print(data)

asyncio.run(main())
```

ä¸Šé¢çš„ç¨‹åºå°±å¯ä»¥æ­£å¸¸è¿è¡Œäº†ï¼Œå¹¶ä¸”è¿”å›ç»“æœ "666"

- ä½¿ç”¨ `Future`åŒ…è£…æ™®é€šå‡½æ•°

ä¸Šé¢æˆ‘ä»¬è¯´è¿‡ï¼Œ`Future`å¯ä»¥åŒ…è£…æ™®é€šå‡½æ•°ï¼Œæˆä¸ºå¯ç­‰å¾…å¯¹è±¡ï¼Œè®©æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ï¼š

```python
import asyncio

def sync_task(fut):
    """æ™®é€šåŒæ­¥å‡½æ•°ï¼Œæ¨¡æ‹Ÿè®¡ç®—ä»»åŠ¡"""
    result = sum(range(10**6))  # è®¡ç®—å¤§æ•°æ±‚å’Œ
    fut.set_result(result)  # æ‰‹åŠ¨è®¾ç½® Future ç»“æœ

async def main():
    loop = asyncio.get_running_loop()
    fut = loop.create_future()

    # åœ¨äº‹ä»¶å¾ªç¯çš„çº¿ç¨‹æ± ä¸­è¿è¡ŒåŒæ­¥å‡½æ•°
    loop.run_in_executor(None, sync_task, fut)

    print("ç­‰å¾…è®¡ç®—ç»“æœ...")
    result = await fut  # ç­‰å¾… Future ç»“æœ
    print("è®¡ç®—å®Œæˆ:", result)

asyncio.run(main())
```

æ³¨æ„å“¦ï¼Œè¿™æ˜¯ä½¿ç”¨çº¿ç¨‹æ± çš„æ–¹å¼æ¥è¿è¡Œæ™®é€šåŒæ­¥å‡½æ•°ï¼Œä¸æ˜¯æ—¶é—´å¾ªç¯

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯`python3.9`ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œè¿˜æœ‰ä¸ªç®€å•çš„å†™æ³•

```python
import asyncio

def sync_task():
    """æ™®é€šåŒæ­¥å‡½æ•°ï¼Œæ¨¡æ‹Ÿè®¡ç®—ä»»åŠ¡"""
    result = sum(range(10**6))  # è®¡ç®—å¤§æ•°æ±‚å’Œ
    return result  # ç›´æ¥è¿”å›ç»“æœ

async def main():
    print("ç­‰å¾…è®¡ç®—ç»“æœ...")

    # ä½¿ç”¨ asyncio.to_thread() è®©åŒæ­¥å‡½æ•°å˜æˆå¯ç­‰å¾…å¯¹è±¡
    result = await asyncio.to_thread(sync_task)

    print("è®¡ç®—å®Œæˆ:", result)

asyncio.run(main())
```

## ä¹ã€å¹¶å‘è¿è¡Œ Task

```python
asyncio.gather(*aws, return_exceptions=False)
```

æˆ‘ä»¬çœ‹ `2.3` çš„ä¾‹å­ï¼Œå…¶å®æœ‰ç®€å•ç‚¹çš„å†™æ³•ã€‚

`gather`æ–¹æ³•ã€‚

å¦‚æœ `return_exceptions` ä¸º `False` (é»˜è®¤)ï¼Œæ‰€å¼•å‘çš„é¦–ä¸ªå¼‚å¸¸ä¼šç«‹å³ä¼ æ’­ç»™ç­‰å¾… `gather()` çš„ä»»åŠ¡ã€‚`aws` åºåˆ—ä¸­çš„å…¶ä»–å¯ç­‰å¾…å¯¹è±¡ ä¸ä¼šè¢«å–æ¶ˆ å¹¶å°†ç»§ç»­è¿è¡Œã€‚

å¦‚æœ `return_exceptions` ä¸º `True`ï¼Œå¼‚å¸¸ä¼šå’ŒæˆåŠŸçš„ç»“æœä¸€æ ·å¤„ç†ï¼Œå¹¶èšåˆè‡³ç»“æœåˆ—è¡¨ã€‚

```python
import asyncio
import time


async def say_after(delay, what):
    await asyncio.sleep(delay)
    print(what)


async def main():
    print(f"started at {time.strftime('%X')}")

    # ç­‰å¾…ç›´åˆ°ä¸¤ä¸ªä»»åŠ¡éƒ½å®Œæˆ
    # ï¼ˆä¼šèŠ±è´¹çº¦ 2 ç§’é’Ÿã€‚ï¼‰
    L = await asyncio.gather(
        say_after(1, 'hello'),
        say_after(2, 'world')
    )
    print(L)

    print(f"finished at {time.strftime('%X')}")


asyncio.run(main())
```

ä½†æ˜¯è¿™ç§æ–¹æ³•ï¼Œè¿˜æ˜¯å’Œ`create_task`æœ‰ç‚¹å„¿åŒºåˆ«

| **åŠŸèƒ½**         | `asyncio.create_task()`        | `asyncio.gather()`                                   |
| ---------------- | ------------------------------ | ---------------------------------------------------- |
| **ä»»åŠ¡åˆ›å»ºæ–¹å¼** | åˆ›å»º**ç‹¬ç«‹è¿è¡Œ**çš„ä»»åŠ¡         | å¯åŠ¨å¤šä¸ªä»»åŠ¡å¹¶**æ”¶é›†ç»“æœ**                           |
| **è¿”å›å€¼**       | `Task` å¯¹è±¡                    | ä»»åŠ¡çš„**ç»“æœåˆ—è¡¨**                                   |
| **æ˜¯å¦ç«‹å³æ‰§è¡Œ** | âœ… ç«‹å³æ‰§è¡Œï¼Œä¸ç­‰å¾… `await`    | âŒ åªæœ‰ `await gather()` æ—¶æ‰æ‰§è¡Œ                    |
| **æ˜¯å¦èƒ½å–æ¶ˆ**   | âœ… å¯ä»¥å•ç‹¬ `task.cancel()`    | âŒ ä¸èƒ½å–æ¶ˆå•ä¸ªä»»åŠ¡ï¼Œåªèƒ½ `cancel()` æ•´ä¸ª `gather()` |
| **é€‚ç”¨åœºæ™¯**     | **è®©ä»»åŠ¡å¹¶è¡Œè¿è¡Œï¼Œä¸å…³å¿ƒç»“æœ** | **å¤šä¸ªä»»åŠ¡å¹¶è¡Œè¿è¡Œï¼Œå¹¶éœ€è¦æ‰€æœ‰ç»“æœ**                 |

## åã€äº‹ä»¶å¾ªç¯

äº‹ä»¶å¾ªç¯æ˜¯`asyncio`å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒï¼Œå®ƒçš„å†…éƒ¨åŸºæœ¬ä¸Šæ˜¯ï¼š

å®ç°äº†ä¸€ä¸ªä»»åŠ¡è°ƒåº¦å™¨ï¼Œç»´æŠ¤ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸æ–­éå†è¿™ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œå°†éœ€è¦ç­‰å¾…çš„å‡½æ•°ä¾åºæ”¾å…¥ä¸€ä¸ª `sleep` é˜Ÿåˆ—ï¼Œå¯¹æ— éœ€ç­‰å¾…çš„å‡½æ•°ç«‹åˆ»è¿è¡Œã€‚

æ›´å¤šçš„å…³é—­äº‹ä»¶å¾ªç¯çš„å†…å®¹ï¼Œæ¨èä½ çœ‹ä¸‹é¢çš„è§†é¢‘äº†è§£ï¼š

[Build Your Own Async](https://www.youtube.com/watch?v=Y4Gt3Xjd7G8&ab_channel=DavidBeazley)

ç°åœ¨ï¼Œè®©æˆ‘ä¸ºä½ ä»‹ç»å‡ ä¸ªå¸¸ç”¨çš„æ—¶é—´å¾ªç¯çš„æ–¹æ³•

### 10.1 è·å–äº‹ä»¶å¾ªç¯

#### get_running_loop

ä»¥ä¸‹ä½å±‚çº§å‡½æ•°å¯è¢«ç”¨äºè·å–ã€è®¾ç½®æˆ–åˆ›å»ºäº‹ä»¶å¾ªç¯

```python
asyncio.get_running_loop()
```

è¿”å›å½“å‰ OS çº¿ç¨‹ä¸­æ­£åœ¨è¿è¡Œçš„äº‹ä»¶å¾ªç¯ã€‚

å¦‚æœæ²¡æœ‰æ­£åœ¨è¿è¡Œçš„äº‹ä»¶å¾ªç¯åˆ™ä¼šå¼•å‘ RuntimeError

æ­¤å‡½æ•°åªèƒ½ç”±åç¨‹æˆ–å›è°ƒæ¥è°ƒç”¨ã€‚

---

#### get_event_loop

```python
asyncio.get_event_loop()
```

è·å–å½“å‰äº‹ä»¶å¾ªç¯ã€‚

å½“åœ¨åç¨‹æˆ–å›è°ƒä¸­è¢«è°ƒç”¨æ—¶ï¼ˆä¾‹å¦‚é€šè¿‡ call_soon æˆ–ç±»ä¼¼ API åŠ å…¥è®¡åˆ’ä»»åŠ¡ï¼‰ï¼Œæ­¤å‡½æ•°å°†å§‹ç»ˆè¿”å›æ­£åœ¨è¿è¡Œçš„äº‹ä»¶å¾ªç¯ã€‚

å¦‚æœæ²¡æœ‰è®¾ç½®æ­£åœ¨è¿è¡Œçš„äº‹ä»¶å¾ªç¯ï¼Œæ­¤å‡½æ•°å°†è¿”å› `get_event_loop_policy().get_event_loop()` è°ƒç”¨çš„ç»“æœã€‚

ç”±äºæ­¤å‡½æ•°å…·æœ‰ç›¸å½“å¤æ‚çš„è¡Œä¸ºï¼ˆç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨äº†è‡ªå®šä¹‰äº‹ä»¶å¾ªç¯ç­–ç•¥çš„æ—¶å€™ï¼‰ï¼Œæ›´æ¨èåœ¨åç¨‹å’Œå›è°ƒä¸­ä½¿ç”¨ `get_running_loop()`å‡½æ•°è€Œé `get_event_loop()`

è¯·è€ƒè™‘ä½¿ç”¨é«˜å±‚çº§çš„`asyncio.run()`å‡½æ•°ï¼Œè€Œä¸æ˜¯ä½¿ç”¨è¿™äº›ä½å±‚çº§çš„å‡½æ•°æ¥æ‰‹åŠ¨åˆ›å»ºå’Œå…³é—­äº‹ä»¶å¾ªç¯ã€‚

> è‡ª 3.12 ç‰ˆæœ¬å¼ƒç”¨: å¦‚æœæ²¡æœ‰å½“å‰äº‹ä»¶å¾ªç¯åˆ™ä¼šå‘å‡ºå¼ƒç”¨è­¦å‘Šã€‚ åœ¨æœªæ¥çš„ Python å‘å¸ƒç‰ˆä¸­è¿™å°†è¢«æ”¹ä¸ºé”™è¯¯ã€‚

### 10.2 åˆ›å»ºä¸€ä¸ªäº‹ä»¶å¾ªç¯

```python
import asyncio

async def say_later(delay, msg):
    await asyncio.sleep(delay)
    print(msg)
    return msg

async def main():
    res = await asyncio.gather(say_later(1, 'hello'), say_later(2, 'world'))
    print(res)

# âœ… é€‚ç”¨äº Python 3.6 åŠä»¥ä¸‹
loop = asyncio.new_event_loop()
asyncio.set_event_loop(loop)
loop.run_until_complete(main())
loop.close()
```

æ³¨æ„ï¼šè¿™ä¸ªç¤ºä¾‹åªé€‚ç”¨ `python3.6`ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œå¦‚æœæ˜¯ `python3.7`ä»¥åçš„ç‰ˆæœ¬ï¼Œå°±å¯ä»¥ä½¿ç”¨ `asyncio.run`æ–¹æ³•ç›´æ¥è°ƒç”¨ï¼Œæ— éœ€æ‰‹åŠ¨åˆ›å»ºäº‹ä»¶å¾ªç¯ã€‚

## åä¸€ã€åœ¨çº¿ç¨‹æˆ–è€…è¿›ç¨‹æ± ä¸­æ‰§è¡Œä»£ç 

ä¸Šé¢ä»‹ç»è¿‡çº¿ç¨‹æ± ï¼Œä¸‹é¢å†ä»‹ç»ä¸€ä¸‹è¿›ç¨‹æ± 

ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä½¿ç”¨çº¿ç¨‹æ± æ‰§è¡Œ`I/O`å¯†é›†å‹ä»»åŠ¡ï¼Œä½¿ç”¨è¿›ç¨‹æ± æ‰§è¡Œ`CPU`å¯†é›†å‹ä»»åŠ¡ã€‚

```python
import asyncio
import concurrent.futures

def blocking_io():
    # æ–‡ä»¶æ“ä½œï¼ˆå¦‚æ—¥å¿—è®°å½•ï¼‰ä¼šé˜»å¡äº‹ä»¶å¾ªç¯ï¼š
    # åº”åœ¨çº¿ç¨‹æ± ä¸­è¿è¡Œå®ƒä»¬ã€‚
    with open('/dev/urandom', 'rb') as f:
        return f.read(100)

def cpu_bound():
    # CPU å¯†é›†å‹æ“ä½œä¼šé˜»å¡äº‹ä»¶å¾ªç¯ï¼š
    # é€šå¸¸å»ºè®®åœ¨è¿›ç¨‹ä¸­è¿è¡Œå®ƒä»¬ã€‚
    return sum(i * i for i in range(10 ** 7))

async def main():
    loop = asyncio.get_running_loop()

    ## Options:

    # 1. è¿è¡Œé»˜è®¤å¾ªç¯çš„æ‰§è¡Œå™¨ï¼š
    result = await loop.run_in_executor(
        None, blocking_io)
    print('default thread pool', result)

    # 2. åœ¨è‡ªå®šä¹‰çš„çº¿ç¨‹æ± ä¸­è¿è¡Œï¼š
    with concurrent.futures.ThreadPoolExecutor() as pool:
        result = await loop.run_in_executor(
            pool, blocking_io)
        print('custom thread pool', result)

    # 3. åœ¨è‡ªå®šä¹‰çš„è¿›ç¨‹æ± ä¸­è¿è¡Œï¼š
    with concurrent.futures.ProcessPoolExecutor() as pool:
        result = await loop.run_in_executor(
            pool, cpu_bound)
        print('custom process pool', result)

if __name__ == '__main__':
    asyncio.run(main())
```

## åäºŒã€å‚è€ƒé“¾æ¥

- [asyncio --- å¼‚æ­¥ I/O](https://docs.python.org/zh-cn/3.13/library/asyncio.html)
